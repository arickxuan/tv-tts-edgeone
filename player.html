<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>视频播放 - KatelyaTV</title>
    <!-- 引入必要的库（作为静态资源，不参与打包） -->
    <script src="./libs/hls.min.js"></script>
    <script src="./libs/artplayer.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .header {
            background: white;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b9d;
            text-decoration: none;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .nav-links a {
            text-decoration: none;
            color: #666;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.3s;
        }

        .nav-links a:hover {
            color: #ff6b9d;
        }

        .nav-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .theme-toggle,
        .user-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #ddd;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-toggle:hover,
        .user-icon:hover {
            background: #f5f5f5;
        }

        /* 搜索框样式 */
        .search-section {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid #e0e0e0;
        }

        .search-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            flex: 1;
            height: 45px;
            padding: 0 20px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            border-color: #ff6b9d;
        }

        .search-input::placeholder {
            color: #aaa;
        }

        .search-btn {
            height: 45px;
            padding: 0 25px;
            background: #ff6b9d;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .search-btn:hover {
            background: #e55a87;
            transform: translateY(-1px);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        .search-btn.loading {
            background: #ccc;
            cursor: not-allowed;
        }

        .search-results-info {
            text-align: center;
            margin: 20px 0;
            color: #666;
            font-size: 14px;
        }

        .search-results-info.hidden {
            display: none;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #666;
            text-decoration: none;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .back-btn:hover {
            color: #ff6b9d;
        }

        .video-section {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .video-title {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .video-title h1 {
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
        }

        .breadcrumb {
            color: #666;
            font-size: 14px;
        }

        .breadcrumb a {
            color: #ff6b9d;
            text-decoration: none;
        }

        .video-player {
            width: 100%;
            background: #000;
            position: relative;
            aspect-ratio: 16/9;
        }

        .video-placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .episode-selector {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .selector-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #2ecc71;
            border-bottom-color: #2ecc71;
        }

        .episode-range {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #666;
        }

        .episode-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .episode-grid.sources-mode {
            display: block;
            gap: 0;
        }

        .episode-btn {
            width: 40px;
            height: 40px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
        }

        .episode-btn:hover {
            border-color: #2ecc71;
            color: #2ecc71;
        }

        .episode-btn.active {
            background: #2ecc71;
            color: white;
            border-color: #2ecc71;
        }

        /* 视频源样式 */
        .source-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 8px;
            background: white;
        }

        .source-info {
            flex: 1;
        }

        .source-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }

        .source-details {
            font-size: 12px;
            color: #666;
            margin-bottom: 2px;
        }

        .source-episodes {
            font-size: 11px;
            color: #999;
        }

        .source-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .source-btn:hover {
            border-color: #2ecc71;
            color: #2ecc71;
        }

        .source-btn.current {
            background: #2ecc71;
            color: white;
            border-color: #2ecc71;
            cursor: default;
        }

        .quality-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: 10px;
            }

            .nav-links {
                display: none;
            }

            .episode-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            /* 移动端搜索框适配 */
            .search-section {
                padding: 15px 10px;
            }

            .search-box {
                flex-direction: column;
                gap: 10px;
            }

            .search-input,
            .search-btn {
                width: 100%;
                max-width: none;
            }

            .search-btn {
                justify-content: center;
            }

            .search-results-info {
                font-size: 12px;
                padding: 0 5px;
            }
        }
    </style>
</head>

<body>
    <header class="header">
        <nav class="nav">
            <a href="#" class="logo">KatelyaTV</a>

            <div class="nav-links">
                <a href="movie.html">🏠 首页</a>
                <a href="movie.html#movie">🎬 电影</a>
                <a href="movie.html#tv">📺 剧集</a>
                <a href="movie.html#show">📖 综艺</a>
            </div>

            <div class="nav-right">
                <div class="theme-toggle">🌙</div>
                <div class="user-icon">👤</div>
            </div>
        </nav>

        <div class="search-section">
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" id="searchInput" placeholder="搜索电影、剧集..." maxlength="50">
                    <button class="search-btn" id="searchBtn">
                        <span>🔍</span>
                        <span id="searchBtnText">搜索</span>
                    </button>
                </div>
            </div>
            <div class="search-results-info hidden" id="searchResultsInfo"></div>
        </div>
    </header>

    <div class="container">
        <main>
            <!-- <a href="#" class="back-btn">
                ← 返回
            </a> -->

            <div class="video-section">
                <div class="video-title">
                    <h1>正在加载...</h1>
                    <div class="breadcrumb">
                        <a href="#">正在加载视频信息...</a>
                    </div>
                </div>

                <div class="video-player" id="player">
                    <!-- <div class="video-placeholder">
                        <div style="text-align: center;">
                            <div style="font-size: 48px; margin-bottom: 10px;">▶️</div>
                            <div>视频播放器</div>
                            <div style="font-size: 14px; margin-top: 5px; opacity: 0.7;">点击播放</div>
                        </div>
                    </div> -->
                </div>
            </div>
        </main>

        <aside class="sidebar">
            <div class="episode-selector">
                <div class="selector-tabs">
                    <button class="tab active">选集</button>
                    <button class="tab">换源</button>
                </div>

                <div class="episode-range">
                    <span>加载中...</span>
                    <div style="margin-left: auto;">
                        <button style="background: none; border: none; cursor: pointer;">🔼</button>
                    </div>
                </div>

                <div class="episode-grid">
                    <div style="grid-column: 1/-1; padding: 20px; text-align: center; color: #666;">
                        正在加载选集信息...
                    </div>
                </div>
            </div>

            <div class="quality-info">
                <div style="margin-bottom: 8px;">🎥 高清播放</div>
                <div>支持1080P高清画质</div>
            </div>
        </aside>
    </div>

    <script>


        let adFilteringEnabled = true;
        let art = null; // 用于 ArtPlayer 实例
        let currentHls = null; // 跟踪当前HLS实例
        let progressSaveInterval = null; // 定期保存进度的计时器
        let currentEpisodes = [];
        let currentVideoUrl = null;
        let videoTitle = '视频播放';
        let videoHasEnded = false;
        let autoplayEnabled = true;
        let userClickedPosition = null;
        let availableSources = []; // 存储可用的视频源

        const urlParams = new URLSearchParams(window.location.search);

        const id = urlParams.get('id');
        const source = urlParams.get('source');
        const index = urlParams.get('index') || '0';
        const title = urlParams.get('title') || '视频播放';
        let currentEpisodeIndex = parseInt(index);

        // 根据URL参数更新页面内容
        function updatePageContent() {
            // 更新页面标题
            const episodeText = parseInt(index) > 0 ? ` 第${parseInt(index) + 1}集` : '';
            const pageTitle = `${title}${episodeText} - KatelyaTV`;
            document.title = pageTitle;
            
            // 更新视频标题
            const videoTitleElement = document.querySelector('.video-title h1');
            if (videoTitleElement) {
                videoTitleElement.textContent = title;
            }
            
            // 更新面包屑导航
            const breadcrumbElement = document.querySelector('.breadcrumb');
            if (breadcrumbElement) {
                const episodeInfo = parseInt(index) > 0 ? ` > 第${parseInt(index) + 1}集` : '';
                breadcrumbElement.innerHTML = `
                    <a href="#">${title}</a>${episodeInfo}
                `;
            }
            
            // 更新全局视频标题变量
            videoTitle = title + episodeText;
            
            console.log('页面内容已更新:', { title, index, pageTitle });
        }

        (function () {
            updatePageContent(); // 首先更新页面内容
            init();
        })();


        async function getVideoUrl(id, source, index) {
            let url = `/movie/detail?id=${id}&source=${source}`;
            let response = await fetch(url);
            let data = await response.json();
            console.log(data);
            currentEpisodes = data.episodes;
            currentVideoUrl = data.episodes[index];
            
            // 更新选集显示
            updateEpisodesDisplay(data.episodes, parseInt(index));
            
            return data.episodes[index];
        }

        // 更新选集显示
        function updateEpisodesDisplay(episodes, currentIndex) {
            if (!episodes || !Array.isArray(episodes) || episodes.length === 0) {
                console.log('没有选集数据');
                return;
            }

            const episodeCount = episodes.length;
            console.log(`更新选集显示: 共${episodeCount}集，当前第${currentIndex + 1}集`);

            // 更新选集范围显示
            const episodeRange = document.querySelector('.episode-range span');
            if (episodeRange) {
                episodeRange.textContent = `1-${episodeCount}`;
            }

            // 生成选集按钮
            const episodeGrid = document.querySelector('.episode-grid');
            if (episodeGrid) {
                let buttonsHtml = '';
                for (let i = 0; i < episodeCount; i++) {
                    const isActive = i === currentIndex ? ' active' : '';
                    buttonsHtml += `<button class="episode-btn${isActive}" data-episode-index="${i}">${i + 1}</button>`;
                }
                episodeGrid.innerHTML = buttonsHtml;

                // 为每个选集按钮绑定点击事件
                bindEpisodeEvents();
            }
        }

        // 绑定选集按钮事件
        function bindEpisodeEvents() {
            document.querySelectorAll('.episode-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const episodeIndex = parseInt(this.getAttribute('data-episode-index'));
                    switchToEpisode(episodeIndex);
                });
            });
        }

        // 切换到指定集数
        function switchToEpisode(episodeIndex) {
            if (!currentEpisodes || episodeIndex < 0 || episodeIndex >= currentEpisodes.length) {
                console.error('无效的集数索引:', episodeIndex);
                return;
            }

            console.log(`切换到第${episodeIndex + 1}集`);

            // 更新激活状态
            document.querySelectorAll('.episode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const targetBtn = document.querySelector(`[data-episode-index="${episodeIndex}"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }

            // 更新全局变量
            currentEpisodeIndex = episodeIndex;
            currentVideoUrl = currentEpisodes[episodeIndex];

            // 更新页面标题和面包屑
            updatePageContentForEpisode(episodeIndex);

            // 切换播放器视频源
            if (art) {
                art.switchUrl(currentVideoUrl);
            }
        }

        // 搜索视频源
        async function searchVideoSources(searchTitle) {
            try {
                console.log('搜索视频源:', searchTitle);
                const response = await fetch(`/movie/search?q=${encodeURIComponent(searchTitle)}`);
                const data = await response.json();
                
                if (data && data.results && Array.isArray(data.results)) {
                    availableSources = data.results;
                    console.log(`找到 ${availableSources.length} 个视频源:`, availableSources);
                    return availableSources;
                } else {
                    console.log('搜索响应格式异常:', data);
                    return [];
                }
            } catch (error) {
                console.error('搜索视频源失败:', error);
                return [];
            }
        }

        // 更新换源显示
        function updateSourcesDisplay() {
            const episodeGrid = document.querySelector('.episode-grid');
            episodeGrid.classList.add('sources-mode');
            
            if (availableSources.length === 0) {
                episodeGrid.innerHTML = `
                    <div style="grid-column: 1/-1; padding: 20px; text-align: center; color: #666;">
                        <div style="margin-bottom: 10px;">🔍 正在搜索视频源...</div>
                        <div style="font-size: 14px; opacity: 0.7;">请稍候</div>
                    </div>
                `;
                
                // 开始搜索
                searchVideoSources(title).then(sources => {
                    if (sources.length > 0) {
                        renderSourcesList(sources);
                    } else {
                        episodeGrid.innerHTML = `
                            <div style="grid-column: 1/-1; padding: 20px; text-align: center; color: #666;">
                                <div style="margin-bottom: 10px;">❌ 未找到其他视频源</div>
                                <div style="font-size: 14px; opacity: 0.7;">当前仅有一个播放源</div>
                            </div>
                        `;
                    }
                });
            } else {
                renderSourcesList(availableSources);
            }
        }

        // 渲染视频源列表
        function renderSourcesList(sources) {
            const episodeGrid = document.querySelector('.episode-grid');
            
            let sourcesHtml = '';
            sources.forEach((sourceItem, index) => {
                const isCurrentSource = sourceItem.source === source;
                const buttonClass = isCurrentSource ? 'source-btn current' : 'source-btn';
                const buttonText = isCurrentSource ? '当前线路' : '切换';
                
                sourcesHtml += `
                    <div class="source-item" data-source-index="${index}">
                        <div class="source-info">
                            <div class="source-name">${sourceItem.source_name}</div>
                            <div class="source-details">${sourceItem.class} • ${sourceItem.year}</div>
                            <div class="source-episodes">${sourceItem.episodes.length}集</div>
                        </div>
                        <button class="${buttonClass}" data-source-index="${index}">${buttonText}</button>
                    </div>
                `;
            });
            
            episodeGrid.innerHTML = sourcesHtml;
            
            // 绑定切换事件
            bindSourceSwitchEvents();
        }

        // 绑定视频源切换事件
        function bindSourceSwitchEvents() {
            document.querySelectorAll('.source-btn:not(.current)').forEach(btn => {
                btn.addEventListener('click', function() {
                    const sourceIndex = parseInt(this.getAttribute('data-source-index'));
                    switchToSource(sourceIndex);
                });
            });
        }

        // 切换到指定视频源
        function switchToSource(sourceIndex) {
            if (!availableSources || sourceIndex < 0 || sourceIndex >= availableSources.length) {
                console.error('无效的源索引:', sourceIndex);
                return;
            }

            const newSource = availableSources[sourceIndex];
            console.log('切换到视频源:', newSource.source_name, newSource);

            // 构建新的播放器URL
            const newUrl = `player.html?id=${newSource.id}&source=${newSource.source}&index=0&title=${encodeURIComponent(newSource.title)}`;
            
            // 跳转到新源
            window.location.href = newUrl;
        }

        // 更新页面内容（针对集数切换）
        function updatePageContentForEpisode(episodeIndex) {
            const episodeText = episodeIndex >= 0 ? ` 第${episodeIndex + 1}集` : '';
            const pageTitle = `${title}${episodeText} - KatelyaTV`;
            
            // 更新页面标题
            document.title = pageTitle;
            
            // 更新面包屑导航
            const breadcrumbElement = document.querySelector('.breadcrumb');
            if (breadcrumbElement) {
                const episodeInfo = episodeIndex >= 0 ? ` > 第${episodeIndex + 1}集` : '';
                breadcrumbElement.innerHTML = `
                    <a href="#">${title}</a>${episodeInfo}
                `;
            }
            
            // 更新全局视频标题变量
            videoTitle = title + episodeText;
            
            console.log('页面内容已更新为集数:', episodeIndex + 1);
        }

        async function init() {
            // 检查必要参数
            if (!id || !source) {
                console.error('缺少必要参数:', { id, source, index, title });
                showError('缺少视频ID或来源参数');
                return;
            }

            try {
                // 获取视频URL
                let videoUrl = await getVideoUrl(id, source, index);
                if (videoUrl) {
                    initPlayer(videoUrl);
                } else {
                    showError('无法获取视频地址');
                }
            } catch (error) {
                console.error('初始化失败:', error);
                showError('视频加载失败: ' + error.message);
            }
        }

        // 自定义M3U8 Loader用于过滤广告 - 使用工厂函数避免初始化顺序问题
        function createCustomHlsJsLoader() {
            if (!window.Hls || !window.Hls.DefaultConfig || !window.Hls.DefaultConfig.loader) {
                console.warn('Hls.js not properly loaded, falling back to default loader');
                return window.Hls ? window.Hls.DefaultConfig.loader : null;
            }
            
            class CustomHlsJsLoader extends window.Hls.DefaultConfig.loader {
                constructor(config) {
                    super(config);
                    const load = this.load.bind(this);
                    this.load = function (context, config, callbacks) {
                        // 拦截manifest和level请求
                        if (context.type === 'manifest' || context.type === 'level') {
                            const onSuccess = callbacks.onSuccess;
                            callbacks.onSuccess = function (response, stats, context) {
                                // 如果是m3u8文件，处理内容以移除广告分段
                                if (response.data && typeof response.data === 'string') {
                                    // 过滤掉广告段 - 实现更精确的广告过滤逻辑
                                    response.data = filterAdsFromM3U8(response.data, true);
                                }
                                return onSuccess(response, stats, context);
                            };
                        }
                        // 执行原始load方法
                        load(context, config, callbacks);
                    };
                }
            }
            return CustomHlsJsLoader;
        }

        // 显示错误信息
        function showError(message) {
            console.error('Player Error:', message);
            const playerContainer = document.getElementById('player');
            if (playerContainer) {
                playerContainer.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #1a1a1a; color: white; text-align: center;">
                        <div>
                            <div style="font-size: 48px; margin-bottom: 15px;">⚠️</div>
                            <div style="font-size: 18px; margin-bottom: 10px;">${message}</div>
                            <div style="font-size: 14px; color: #aaa;">请尝试刷新页面或更换视频源</div>
                        </div>
                    </div>
                `;
            }
        }

        // 获取视频ID用于进度保存
        function getVideoId() {
            const urlParams = new URLSearchParams(window.location.search);
            return `${urlParams.get('source') || 'unknown'}_${urlParams.get('id') || 'unknown'}_${urlParams.get('index') || '0'}`;
        }

        // 显示位置恢复提示
        function showPositionRestoreHint(position) {
            // 简单的控制台日志，您可以根据需要实现UI提示
            console.log(`已恢复到播放位置: ${Math.floor(position)}秒`);
        }

        // 显示快捷键提示
        function showShortcutHint(text, position = 'center') {
            // 简单的控制台日志，您可以根据需要实现UI提示
            console.log(`快捷键提示: ${text}`);
        }

        // 清除视频播放进度
        function clearVideoProgress() {
            try {
                const progressKey = 'videoProgress_' + getVideoId();
                localStorage.removeItem(progressKey);
            } catch (e) {
                console.error('Failed to clear video progress:', e);
            }
        }

        // 播放下一集
        function playNextEpisode() {
            const nextIndex = parseInt(currentEpisodeIndex) + 1;
            if (nextIndex < currentEpisodes.length) {
                const urlParams = new URLSearchParams(window.location.search);
                urlParams.set('index', nextIndex);
                window.location.href = window.location.pathname + '?' + urlParams.toString();
            }
        }

        // 安全地隐藏元素
        function safeHideElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
            }
        }

        // 安全地显示元素
        function safeShowElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
            }
        }

        // 过滤可疑的广告内容
        function filterAdsFromM3U8(m3u8Content, strictMode = false) {
            if (!m3u8Content) return '';

            // 按行分割M3U8内容
            const lines = m3u8Content.split('\n');
            const filteredLines = [];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];

                // 只过滤#EXT-X-DISCONTINUITY标识
                if (!line.includes('#EXT-X-DISCONTINUITY')) {
                    filteredLines.push(line);
                }
            }

            return filteredLines.join('\n');
        }


        // 初始化播放器
        function initPlayer(videoUrl) {
            if (!videoUrl) {
                return
            }

            // 销毁旧实例
            if (art) {
                art.destroy();
                art = null;
            }

            // 配置HLS.js选项
            const CustomLoader = adFilteringEnabled ? createCustomHlsJsLoader() : null;
            const hlsConfig = {
                debug: false,
                loader: CustomLoader || (window.Hls ? window.Hls.DefaultConfig.loader : undefined),
                enableWorker: true,
                lowLatencyMode: false,
                backBufferLength: 90,
                maxBufferLength: 30,
                maxMaxBufferLength: 60,
                maxBufferSize: 30 * 1000 * 1000,
                maxBufferHole: 0.5,
                fragLoadingMaxRetry: 6,
                fragLoadingMaxRetryTimeout: 64000,
                fragLoadingRetryDelay: 1000,
                manifestLoadingMaxRetry: 3,
                manifestLoadingRetryDelay: 1000,
                levelLoadingMaxRetry: 4,
                levelLoadingRetryDelay: 1000,
                startLevel: -1,
                abrEwmaDefaultEstimate: 500000,
                abrBandWidthFactor: 0.95,
                abrBandWidthUpFactor: 0.7,
                abrMaxWithRealBitrate: true,
                stretchShortVideoTrack: true,
                appendErrorMaxRetry: 5,  // 增加尝试次数
                liveSyncDurationCount: 3,
                liveDurationInfinity: false
            };

            // Create new ArtPlayer instance
            art = new Artplayer({
                container: '#player',
                url: videoUrl,
                type: 'm3u8',
                title: videoTitle,
                volume: 0.8,
                isLive: false,
                muted: false,
                autoplay: true,
                pip: true,
                autoSize: false,
                autoMini: true,
                screenshot: true,
                setting: true,
                loop: false,
                flip: false,
                playbackRate: true,
                aspectRatio: false,
                fullscreen: true,
                fullscreenWeb: true,
                subtitleOffset: false,
                miniProgressBar: true,
                mutex: true,
                backdrop: true,
                playsInline: true,
                autoPlayback: false,
                airplay: true,
                hotkey: false,
                theme: '#23ade5',
                lang: navigator.language.toLowerCase(),
                moreVideoAttr: {
                    crossOrigin: 'anonymous',
                },
                customType: {
                    m3u8: function (video, url) {
                        // 清理之前的HLS实例
                        if (currentHls && currentHls.destroy) {
                            try {
                                currentHls.destroy();
                            } catch (e) {
                            }
                        }

                        // 检查HLS库是否正确加载
                        if (!window.Hls) {
                            console.error('Hls.js library not loaded');
                            showError('视频播放库未加载，请刷新页面重试');
                            return;
                        }

                        // 创建新的HLS实例
                        const hls = new window.Hls(hlsConfig);
                        currentHls = hls;

                        // 跟踪是否已经显示错误
                        let errorDisplayed = false;
                        // 跟踪是否有错误发生
                        let errorCount = 0;
                        // 跟踪视频是否开始播放
                        let playbackStarted = false;
                        // 跟踪视频是否出现bufferAppendError
                        let bufferAppendErrorCount = 0;

                        // 监听视频播放事件
                        video.addEventListener('playing', function () {
                            playbackStarted = true;
                            safeHideElement('player-loading');
                            safeHideElement('error');
                        });

                        // 监听视频进度事件
                        video.addEventListener('timeupdate', function () {
                            if (video.currentTime > 1) {
                                // 视频进度超过1秒，隐藏错误（如果存在）
                                safeHideElement('error');
                            }
                        });

                        hls.loadSource(url);
                        hls.attachMedia(video);

                        // enable airplay, from https://github.com/video-dev/hls.js/issues/5989
                        // 检查是否已存在source元素，如果存在则更新，不存在则创建
                        let sourceElement = video.querySelector('source');
                        if (sourceElement) {
                            // 更新现有source元素的URL
                            sourceElement.src = videoUrl;
                        } else {
                            // 创建新的source元素
                            sourceElement = document.createElement('source');
                            sourceElement.src = videoUrl;
                            video.appendChild(sourceElement);
                        }
                        video.disableRemotePlayback = false;

                        hls.on(window.Hls.Events.MANIFEST_PARSED, function () {
                            video.play().catch(e => {
                            });
                        });

                        hls.on(window.Hls.Events.ERROR, function (event, data) {
                            // 增加错误计数
                            errorCount++;

                            // 处理bufferAppendError
                            if (data.details === 'bufferAppendError') {
                                bufferAppendErrorCount++;
                                // 如果视频已经开始播放，则忽略这个错误
                                if (playbackStarted) {
                                    return;
                                }

                                // 如果出现多次bufferAppendError但视频未播放，尝试恢复
                                if (bufferAppendErrorCount >= 3) {
                                    hls.recoverMediaError();
                                }
                            }

                            // 如果是致命错误，且视频未播放
                            if (data.fatal && !playbackStarted) {
                                // 尝试恢复错误
                                switch (data.type) {
                                    case window.Hls.ErrorTypes.NETWORK_ERROR:
                                        hls.startLoad();
                                        break;
                                    case window.Hls.ErrorTypes.MEDIA_ERROR:
                                        hls.recoverMediaError();
                                        break;
                                    default:
                                        // 仅在多次恢复尝试后显示错误
                                        if (errorCount > 3 && !errorDisplayed) {
                                            errorDisplayed = true;
                                            showError('视频加载失败，可能是格式不兼容或源不可用');
                                        }
                                        break;
                                }
                            }
                        });

                        // 监听分段加载事件
                        hls.on(window.Hls.Events.FRAG_LOADED, function () {
                            safeHideElement('player-loading');
                        });

                        // 监听级别加载事件
                        hls.on(window.Hls.Events.LEVEL_LOADED, function () {
                            safeHideElement('player-loading');
                        });
                    }
                }
            });


            // artplayer 没有 'fullscreenWeb:enter', 'fullscreenWeb:exit' 等事件
            // 所以原控制栏隐藏代码并没有起作用
            // 实际起作用的是 artplayer 默认行为，它支持自动隐藏工具栏
            // 但有一个 bug： 在副屏全屏时，鼠标移出副屏后不会自动隐藏工具栏
            // 下面进一并重构和修复：
            let hideTimer;

            // 隐藏控制栏
            function hideControls() {
                if (art && art.controls) {
                    art.controls.show = false;
                }
            }

            // 重置计时器，计时器超时时间与 artplayer 保持一致
            function resetHideTimer() {
                clearTimeout(hideTimer);
                hideTimer = setTimeout(() => {
                    hideControls();
                }, Artplayer.CONTROL_HIDE_TIME);
            }

            // 处理鼠标离开浏览器窗口
            function handleMouseOut(e) {
                if (e && !e.relatedTarget) {
                    resetHideTimer();
                }
            }

            // 全屏状态切换时注册/移除 mouseout 事件，监听鼠标移出屏幕事件
            // 从而对播放器状态栏进行隐藏倒计时
            function handleFullScreen(isFullScreen, isWeb) {
                if (isFullScreen) {
                    document.addEventListener('mouseout', handleMouseOut);
                } else {
                    document.removeEventListener('mouseout', handleMouseOut);
                    // 退出全屏时清理计时器
                    clearTimeout(hideTimer);
                }

                if (!isWeb) {
                    if (window.screen.orientation && window.screen.orientation.lock) {
                        window.screen.orientation.lock('landscape')
                            .then(() => {
                            })
                            .catch((error) => {
                            });
                    }
                }
            }

            // 播放器加载完成后初始隐藏工具栏
            art.on('ready', () => {
                hideControls();
            });

            // 全屏 Web 模式处理
            art.on('fullscreenWeb', function (isFullScreen) {
                handleFullScreen(isFullScreen, true);
            });

            // 全屏模式处理
            art.on('fullscreen', function (isFullScreen) {
                handleFullScreen(isFullScreen, false);
            });

            art.on('video:loadedmetadata', function () {
                safeHideElement('player-loading');
                videoHasEnded = false; // 视频加载时重置结束标志
                // 优先使用URL传递的position参数
                const urlParams = new URLSearchParams(window.location.search);
                const savedPosition = parseInt(urlParams.get('position') || '0');

                if (savedPosition > 10 && savedPosition < art.duration - 2) {
                    // 如果URL中有有效的播放位置参数，直接使用它
                    art.currentTime = savedPosition;
                    showPositionRestoreHint(savedPosition);
                } else {
                    // 否则尝试从本地存储恢复播放进度
                    try {
                        const progressKey = 'videoProgress_' + getVideoId();
                        const progressStr = localStorage.getItem(progressKey);
                        if (progressStr && art.duration > 0) {
                            const progress = JSON.parse(progressStr);
                            if (
                                progress &&
                                typeof progress.position === 'number' &&
                                progress.position > 10 &&
                                progress.position < art.duration - 2
                            ) {
                                art.currentTime = progress.position;
                                showPositionRestoreHint(progress.position);
                            }
                        }
                    } catch (e) {
                    }
                }

                // 设置进度条点击监听
                setupProgressBarPreciseClicks();

                // 视频加载成功后，在稍微延迟后将其添加到观看历史
                setTimeout(saveToHistory, 3000);

                // 启动定期保存播放进度
                startProgressSaveInterval();
            })

            // 错误处理
            art.on('video:error', function (error) {
                // 如果正在切换视频，忽略错误
                if (window.isSwitchingVideo) {
                    return;
                }

                // 隐藏所有加载指示器
                const loadingElements = document.querySelectorAll('#player-loading, .player-loading-container');
                loadingElements.forEach(el => {
                    if (el) el.style.display = 'none';
                });

                showError('视频播放失败: ' + (error.message || '未知错误'));
            });

            // 添加移动端长按三倍速播放功能
            setupLongPressSpeedControl();

            // 视频播放结束事件
            art.on('video:ended', function () {
                videoHasEnded = true;

                clearVideoProgress();

                // 如果自动播放下一集开启，且确实有下一集
                if (autoplayEnabled && currentEpisodeIndex < currentEpisodes.length - 1) {
                    // 稍长延迟以确保所有事件处理完成
                    setTimeout(() => {
                        // 确认不是因为用户拖拽导致的假结束事件
                        playNextEpisode();
                        videoHasEnded = false; // 重置标志
                    }, 1000);
                } else {
                    art.fullscreen = false;
                }
            });

            // 添加双击全屏支持
            art.on('video:playing', () => {
                // 绑定双击事件到视频容器
                if (art.video) {
                    art.video.addEventListener('dblclick', () => {
                        art.fullscreen = !art.fullscreen;
                        art.play();
                    });
                }
            });

            // 10秒后如果仍在加载，但不立即显示错误
            setTimeout(function () {
                // 如果视频已经播放开始，则不显示错误
                if (art && art.video && art.video.currentTime > 0) {
                    return;
                }

                const loadingElement = document.getElementById('player-loading');
                if (loadingElement && loadingElement.style.display !== 'none') {
                    loadingElement.innerHTML = `
            <div class="loading-spinner"></div>
            <div>视频加载时间较长，请耐心等待...</div>
            <div style="font-size: 12px; color: #aaa; margin-top: 10px;">如长时间无响应，请尝试其他视频源</div>
        `;
                }
            }, 10000);
        }

        // 设置移动端长按三倍速播放功能
        function setupLongPressSpeedControl() {
            if (!art || !art.video) return;

            const playerElement = document.getElementById('player');
            let longPressTimer = null;
            let originalPlaybackRate = 1.0;
            let isLongPress = false;

            // 显示快速提示
            function showSpeedHint(speed) {
                showShortcutHint(`${speed}倍速`, 'right');
            }

            // 禁用右键
            playerElement.oncontextmenu = () => {
                // 检测是否为移动设备
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);

                // 只在移动设备上禁用右键
                if (isMobile) {
                    const dplayerMenu = document.querySelector(".dplayer-menu");
                    const dplayerMask = document.querySelector(".dplayer-mask");
                    if (dplayerMenu) dplayerMenu.style.display = "none";
                    if (dplayerMask) dplayerMask.style.display = "none";
                    return false;
                }
                return true; // 在桌面设备上允许右键菜单
            };

            // 触摸开始事件
            playerElement.addEventListener('touchstart', function (e) {
                // 检查视频是否正在播放，如果没有播放则不触发长按功能
                if (art.video.paused) {
                    return; // 视频暂停时不触发长按功能
                }

                // 保存原始播放速度
                originalPlaybackRate = art.video.playbackRate;

                // 设置长按计时器
                longPressTimer = setTimeout(() => {
                    // 再次检查视频是否仍在播放
                    if (art.video.paused) {
                        clearTimeout(longPressTimer);
                        longPressTimer = null;
                        return;
                    }

                    // 长按超过500ms，设置为3倍速
                    art.video.playbackRate = 3.0;
                    isLongPress = true;
                    showSpeedHint(3.0);

                    // 只在确认为长按时阻止默认行为
                    e.preventDefault();
                }, 500);
            }, { passive: false });

            // 触摸结束事件
            playerElement.addEventListener('touchend', function (e) {
                // 清除长按计时器
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }

                // 如果是长按状态，恢复原始播放速度
                if (isLongPress) {
                    art.video.playbackRate = originalPlaybackRate;
                    isLongPress = false;
                    showSpeedHint(originalPlaybackRate);

                    // 阻止长按后的点击事件
                    e.preventDefault();
                }
                // 如果不是长按，则允许正常的点击事件（暂停/播放）
            });

            // 触摸取消事件
            playerElement.addEventListener('touchcancel', function () {
                // 清除长按计时器
                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }

                // 如果是长按状态，恢复原始播放速度
                if (isLongPress) {
                    art.video.playbackRate = originalPlaybackRate;
                    isLongPress = false;
                }
            });

            // 触摸移动事件 - 防止在长按时触发页面滚动
            playerElement.addEventListener('touchmove', function (e) {
                if (isLongPress) {
                    e.preventDefault();
                }
            }, { passive: false });

            // 视频暂停时取消长按状态
            art.video.addEventListener('pause', function () {
                if (isLongPress) {
                    art.video.playbackRate = originalPlaybackRate;
                    isLongPress = false;
                }

                if (longPressTimer) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            });
        }


        // 设置进度条准确点击处理
        function setupProgressBarPreciseClicks() {
            // 查找DPlayer的进度条元素
            const progressBar = document.querySelector('.dplayer-bar-wrap');
            if (!progressBar || !art || !art.video) return;

            // 移除可能存在的旧事件监听器
            progressBar.removeEventListener('mousedown', handleProgressBarClick);

            // 添加新的事件监听器
            progressBar.addEventListener('mousedown', handleProgressBarClick);

            // 在移动端也添加触摸事件支持
            progressBar.removeEventListener('touchstart', handleProgressBarTouch);
            progressBar.addEventListener('touchstart', handleProgressBarTouch);

            // 处理进度条点击
            function handleProgressBarClick(e) {
                if (!art || !art.video) return;

                // 计算点击位置相对于进度条的比例
                const rect = e.currentTarget.getBoundingClientRect();
                const percentage = (e.clientX - rect.left) / rect.width;

                // 计算点击位置对应的视频时间
                const duration = art.video.duration;
                let clickTime = percentage * duration;

                // 处理视频接近结尾的情况
                if (duration - clickTime < 1) {
                    // 如果点击位置非常接近结尾，稍微往前移一点
                    clickTime = Math.min(clickTime, duration - 1.5);

                }

                // 记录用户点击的位置
                userClickedPosition = clickTime;

                // 阻止默认事件传播，避免DPlayer内部逻辑将视频跳至末尾
                e.stopPropagation();

                // 直接设置视频时间
                art.seek(clickTime);
            }

            // 处理移动端触摸事件
            function handleProgressBarTouch(e) {
                if (!art || !art.video || !e.touches[0]) return;

                const touch = e.touches[0];
                const rect = e.currentTarget.getBoundingClientRect();
                const percentage = (touch.clientX - rect.left) / rect.width;

                const duration = art.video.duration;
                let clickTime = percentage * duration;

                // 处理视频接近结尾的情况
                if (duration - clickTime < 1) {
                    clickTime = Math.min(clickTime, duration - 1.5);
                }

                // 记录用户点击的位置
                userClickedPosition = clickTime;

                e.stopPropagation();
                art.seek(clickTime);
            }
        }


        // 在播放器初始化后添加视频到历史记录
        function saveToHistory() {
            // 确保 currentEpisodes 非空且有当前视频URL
            if (!currentEpisodes || currentEpisodes.length === 0 || !currentVideoUrl) {
                return;
            }

            // 尝试从URL中获取参数
            const urlParams = new URLSearchParams(window.location.search);
            const sourceName = urlParams.get('source') || '';
            const sourceCode = urlParams.get('source') || '';
            const id_from_params = urlParams.get('id'); // Get video ID from player URL (passed as 'id')

            // 获取当前播放进度
            let currentPosition = 0;
            let videoDuration = 0;

            if (art && art.video) {
                currentPosition = art.video.currentTime;
                videoDuration = art.video.duration;
            }

            // Define a show identifier: Prioritize sourceName_id, fallback to first episode URL or current video URL
            let show_identifier_for_video_info;
            if (sourceName && id_from_params) {
                show_identifier_for_video_info = `${sourceName}_${id_from_params}`;
            } else {
                show_identifier_for_video_info = (currentEpisodes && currentEpisodes.length > 0) ? currentEpisodes[0] : currentVideoUrl;
            }

            // 构建要保存的视频信息对象
            const videoInfo = {
                title: "123",
                directVideoUrl: currentVideoUrl, // Current episode's direct URL
                url: `player.html?url=&source=${encodeURIComponent(sourceName)}&id=${encodeURIComponent(id_from_params || '')}&index=${index}&position=${Math.floor(currentPosition || 0)}`,
                episodeIndex: currentEpisodeIndex,
                sourceName: sourceName,
                vod_id: id_from_params || '', // Store the ID from params as vod_id in history item
                sourceCode: sourceCode,
                showIdentifier: show_identifier_for_video_info, // Identifier for the show/series
                timestamp: Date.now(),
                playbackPosition: currentPosition,
                duration: videoDuration,
                episodes: currentEpisodes && currentEpisodes.length > 0 ? [...currentEpisodes] : []
            };

            try {
                const history = JSON.parse(localStorage.getItem('viewingHistory') || '[]');

                // 检查是否已经存在相同的系列记录 (基于标题、来源和 showIdentifier)
                const existingIndex = history.findIndex(item =>
                    item.title === videoInfo.title &&
                    item.sourceName === videoInfo.sourceName &&
                    item.showIdentifier === videoInfo.showIdentifier
                );

                if (existingIndex !== -1) {
                    // 存在则更新现有记录的当前集数、时间戳、播放进度和URL等
                    const existingItem = history[existingIndex];
                    existingItem.episodeIndex = videoInfo.episodeIndex;
                    existingItem.timestamp = videoInfo.timestamp;
                    existingItem.sourceName = videoInfo.sourceName; // Should be consistent, but update just in case
                    existingItem.sourceCode = videoInfo.sourceCode;
                    existingItem.vod_id = videoInfo.vod_id;

                    // Update URLs to reflect the current episode being watched
                    existingItem.directVideoUrl = videoInfo.directVideoUrl; // Current episode's direct URL
                    existingItem.url = videoInfo.url; // Player link for the current episode

                    // 更新播放进度信息
                    existingItem.playbackPosition = videoInfo.playbackPosition > 10 ? videoInfo.playbackPosition : (existingItem.playbackPosition || 0);
                    existingItem.duration = videoInfo.duration || existingItem.duration;

                    // 更新集数列表（如果新的集数列表与存储的不同，例如集数增加了）
                    if (videoInfo.episodes && videoInfo.episodes.length > 0) {
                        if (!existingItem.episodes ||
                            !Array.isArray(existingItem.episodes) ||
                            existingItem.episodes.length !== videoInfo.episodes.length ||
                            !videoInfo.episodes.every((ep, i) => ep === existingItem.episodes[i])) { // Basic check for content change
                            existingItem.episodes = [...videoInfo.episodes]; // Deep copy
                        }
                    }

                    // 移到最前面
                    const updatedItem = history.splice(existingIndex, 1)[0];
                    history.unshift(updatedItem);
                } else {
                    // 添加新记录到最前面
                    history.unshift(videoInfo);
                }

                // 限制历史记录数量为50条
                if (history.length > 50) history.splice(50);

                localStorage.setItem('viewingHistory', JSON.stringify(history));
            } catch (e) {
            }
        }

        // 开始定期保存播放进度
        function startProgressSaveInterval() {
            // 清除可能存在的旧计时器
            if (progressSaveInterval) {
                clearInterval(progressSaveInterval);
            }

            // 每30秒保存一次播放进度
            //progressSaveInterval = setInterval(saveCurrentProgress, 30000);
        }

        // 选集切换功能现在由动态生成的按钮处理（在 updateEpisodesDisplay 和 bindEpisodeEvents 函数中）

        // 标签切换功能
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');

                if (this.textContent === '换源') {
                    // 切换到换源标签
                    document.querySelector('.episode-range').style.display = 'none';
                    updateSourcesDisplay();
                } else {
                    // 切换回选集标签，恢复选集显示
                    document.querySelector('.episode-range').style.display = 'flex';
                    
                    // 移除换源模式的CSS类
                    const episodeGrid = document.querySelector('.episode-grid');
                    episodeGrid.classList.remove('sources-mode');
                    
                    // 使用动态选集显示功能
                    if (currentEpisodes && currentEpisodes.length > 0) {
                        updateEpisodesDisplay(currentEpisodes, currentEpisodeIndex);
                    } else {
                        // 如果没有选集数据，显示加载中
                        episodeGrid.innerHTML = `
                            <div style="grid-column: 1/-1; padding: 20px; text-align: center; color: #666;">
                                正在加载选集信息...
                            </div>
                        `;
                    }
                }
            });
        });

        // 主题切换功能
        document.querySelector('.theme-toggle').addEventListener('click', function () {
            document.body.style.filter = document.body.style.filter ? '' : 'invert(1) hue-rotate(180deg)';
            this.textContent = this.textContent === '🌙' ? '☀️' : '🌙';
        });

        // 视频播放器点击事件
        document.querySelector('.video-placeholder').addEventListener('click', function () {

        });
    </script>
</body>

</html>